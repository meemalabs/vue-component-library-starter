<script setup lang="ts">
import { useHealthStore } from '~/stores/health'

const healthStore = useHealthStore()
const loading = ref(true)

onMounted(async () => {
  await fetchHealthStats()

  loading.value = false
})

async function fetchHealthStats() {
  await Promise.all([
    healthStore.fetchUptime(),
    healthStore.fetchCertificate(),
    healthStore.fetchBrokenLinks(),
    healthStore.fetchSiteChecks(),
    healthStore.fetchDnsHistoryItems(),
  ])
}

const certificateExpiration = computed(() => {
  const certificateChecks = healthStore.certificate.certificateChecks
  let expiry = {}

  if (certificateChecks.length) {
    expiry = certificateChecks.find((certificate) => {
      return certificate.type === 'expiresSoon'
    })
  }

  return expiry.label || 'N/A'
})
</script>

<template>
  <div>
    <div class="overflow-hidden bg-gray-200 divide-y divide-gray-200 rounded-lg dark:bg-gray-600 dark:divide-gray-600 sm:grid sm:grid-cols-2 sm:gap-px sm:divide-y-0">
      <div class="relative p-6 bg-white dark:bg-gray-700 group">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 mt-0.5 rounded-full bg-carefree-green-1" />
          <h3 class="text-lg">
            <a
              href="#"
              class="font-semibold focus:outline-none hover:text-home-teal-button"
            >
              Uptime
            </a>
          </h3>
        </div>
        <div
          class="mt-8"
        >
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            Your site is up. We last checked less than a minute ago.
          </p>

          <div>
            <ListLoader
              v-if="loading"
              :lines="2"
              :cols="3"
            />

            <dl
              v-if="!isEmpty(healthStore.uptime) && !loading"
              class="grid grid-cols-1 mt-5 overflow-hidden bg-white border divide-y divide-gray-200 rounded-lg dark:bg-gray-600 dark:divide-gray-500 dark:border-gray-500 md:grid-cols-3 md:divide-y-0 md:divide-x"
            >
              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  Past 7 Days
                </dt>

                <dd

                  class="flex items-baseline justify-between mt-1 md:block lg:flex"
                >
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    {{ healthStore.uptime.week }}%
                  </div>
                </dd>
              </div>

              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  Past 14 Days
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    {{ healthStore.uptime.two_weeks }}%
                  </div>
                </dd>
              </div>

              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  Past 30 Days
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    {{ healthStore.uptime.month }}%
                  </div>
                </dd>
              </div>
            </dl>
          </div>
        </div>
      </div>
      <div class="relative p-6 bg-white dark:bg-gray-700 group">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 mt-0.5 rounded-full bg-carefree-green-1" />
          <h3 class="text-lg">
            <a
              href="#"
              class="font-semibold focus:outline-none hover:text-home-teal-button"
            >
              Performance
            </a>
          </h3>
        </div>
        <div
          class="mt-8"
        >
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            We're monitoring the performance of your site. Your site is fast. We last checked 3 minutes ago.
          </p>
        </div>
      </div>
      <div class="relative p-6 bg-white dark:bg-gray-700 group">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 mt-0.5 rounded-full bg-carefree-green-1" />
          <h3 class="text-lg">
            <a
              href="#"
              class="font-semibold focus:outline-none hover:text-home-teal-button"
            >
              Certificate health
            </a>
          </h3>
        </div>
        <div
          class="mt-8"
        >
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            Your certificate is healthy. We last checked 3 minutes ago.
          </p>

          <ListLoader
            v-if="loading"
            :lines="2"
            :cols="1"
          />

          <div v-if="!isEmpty(healthStore.certificate) && !loading">
            <dl class="mt-5 overflow-hidden bg-white border divide-y divide-gray-200 rounded-lg dark:divide-gray-500 dark:bg-gray-600 dark:border-gray-500">
              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  Expires In
                </dt>
                <dd class="mt-1">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    {{ certificateExpiration }}
                  </div>
                </dd>
              </div>
            </dl>
          </div>
        </div>
        <span
          class="absolute text-gray-300 pointer-events-none top-6 right-6 group-hover:text-gray-400"
          aria-hidden="true"
        >
          <svg
            class="w-6 h-6"
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M20 4h1a1 1 0 00-1-1v1zm-1 12a1 1 0 102 0h-2zM8 3a1 1 0 000 2V3zM3.293 19.293a1 1 0 101.414 1.414l-1.414-1.414zM19 4v12h2V4h-2zm1-1H8v2h12V3zm-.707.293l-16 16 1.414 1.414 16-16-1.414-1.414z" />
          </svg>
        </span>
      </div>
      <div class="relative p-6 bg-white dark:bg-gray-700 group">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 mt-0.5 rounded-full bg-carefree-green-1" />
          <h3 class="text-lg">
            <a
              href="#"
              class="font-semibold focus:outline-none hover:text-home-teal-button"
            >
              Broken Links
            </a>
          </h3>
        </div>
        <div
          class="mt-8"
        >
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            Your site has {{ healthStore.brokenLinks.length || 'no' }} broken links.
          </p>

          <ListLoader
            v-if="loading"
            :lines="2"
            :cols="2"
          />
          <div v-if="!isEmpty(healthStore.brokenLinks) && !loading">
            <dl class="grid grid-cols-1 mt-5 overflow-hidden bg-white border divide-y divide-gray-200 rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:divide-gray-500 md:grid-cols-2 md:divide-y-0 md:divide-x">
              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  Broken Links
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    {{ healthStore.brokenLinks.length }}
                  </div>
                </dd>
              </div>

              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  URLs Crawled
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    221
                  </div>
                </dd>
              </div>
            </dl>
          </div>
        </div>
      </div>
      <div class="relative p-6 bg-white dark:bg-gray-700 group">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 mt-0.5 rounded-full bg-carefree-green-1" />
          <h3 class="text-lg">
            <a
              href="#"
              class="font-semibold focus:outline-none hover:text-home-teal-button"
            >
              Mixed Content
            </a>
          </h3>
        </div>
        <div
          class="mt-8"
        >
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            We did not find mixed content. We last checked an hour ago.
          </p>
          <ListLoader
            v-if="loading"
            :lines="2"
            :cols="2"
          />
          <div v-if="!isEmpty(healthStore.mixedContent) && !loading">
            <dl class="grid grid-cols-1 mt-5 overflow-hidden bg-white border divide-y divide-gray-200 rounded-lg dark:bg-gray-600 dark:divide-gray-500 dark:border-gray-500 md:grid-cols-2 md:divide-y-0 md:divide-x">
              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  Pieces of Mixed Content
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    {{ healthStore.mixedContent.length }}
                  </div>
                </dd>
              </div>

              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  URLs Crawled
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    221
                  </div>
                </dd>
              </div>
            </dl>
          </div>
        </div>
      </div>
      <div class="relative p-6 bg-white dark:bg-gray-700 group">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 mt-0.5 rounded-full bg-carefree-blue-1" />
          <h3 class="text-lg">
            <a
              href="#"
              class="font-semibold focus:outline-none hover:text-home-teal-button"
            >
              Certificate transparency
            </a>
          </h3>
        </div>
        <div
          class="mt-8"
        >
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            Your site is up. We last checked less than a minute ago.
          </p>
        </div>
      </div>
      <div class="relative p-6 bg-white dark:bg-gray-700 group">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 mt-0.5 rounded-full bg-carefree-green-1" />
          <h3 class="text-lg">
            <a
              href="#"
              class="font-semibold focus:outline-none hover:text-home-teal-button"
            >
              Application Health
            </a>
          </h3>
        </div>
        <div
          class="mt-8"
        >
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            Your application seems to be healthy. We last checked 10 minutes ago.
          </p>

          <ListLoader
            v-if="loading"
            :lines="2"
            :cols="2"
          />

          <div v-if="!loading">
            <dl
              class="grid grid-cols-1 mt-5 overflow-hidden bg-white border divide-y divide-gray-200 rounded-lg dark:bg-gray-600 dark:divide-gray-500 dark:border-gray-500 md:grid-cols-2 md:divide-y-0 md:divide-x"
            >
              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  Total Health Checks
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    2
                  </div>
                </dd>
              </div>

              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  Failed Health Checks
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    0
                  </div>
                </dd>
              </div>
            </dl>
          </div>
        </div>
      </div>
      <div class="relative p-6 bg-white dark:bg-gray-700 group">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 mt-0.5 rounded-full bg-carefree-green-1" />
          <h3 class="text-lg">
            <a
              href="#"
              class="font-semibold focus:outline-none hover:text-home-teal-button"
            >
              DNS
            </a>
          </h3>
        </div>

        <ListLoader
          v-if="loading"
          :lines="2"
          :cols="2"
        />
        <div
          v-if="!isEmpty(healthStore.dns) && !loading"
          class="mt-8"
        >
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            DNS records found. We last checked an hour ago.
          </p>
          <div>
            <dl class="grid grid-cols-1 mt-5 overflow-hidden bg-white border divide-y divide-gray-200 rounded-lg dark:border-gray-500 dark:bg-gray-600 dark:divide-gray-500 lg md:grid-cols-2 md:divide-y-0 md:divide-x">
              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  DNS Records
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div
                    v-if="healthStore.dns.dnsRecords"
                    class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100"
                  >
                    {{ healthStore.dns.dnsRecords.length }}
                  </div>
                </dd>
              </div>

              <div class="p-2 sm:p-3">
                <dt class="text-sm text-gray-500 dark:text-gray-200">
                  URLs Crawled
                </dt>
                <dd class="flex items-baseline justify-between mt-1 md:block lg:flex">
                  <div class="pt-4 text-sm font-semibold text-gray-900 dark:text-gray-100">
                    20
                  </div>
                </dd>
              </div>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
